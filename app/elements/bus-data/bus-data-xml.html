<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="bus-data-xml">
  <style>
    paper-material {
      padding-top: 8px;
      padding-bottom: 8px;
      padding-left: 24px;
      margin-left: 4px;
      margin-right: 4px;
    }
    paper-dialog {
      border: 2px solid;
      border-color: lightgoldenrodyellow;
      background-color: white;
      color: black;
    }
    paper-dialog {
      position: fixed;
      width: 300px;
      margin: 16px;
      overflow: auto;
    }
  </style>
  <template>

    <paper-material>
      <p>Route: {{routeTitle}}</p>
      <p>Direction: {{directionTitle}}</p>
      <p>Stop: {{stopTitle}}</p>
    </paper-material>

    <iron-ajax auto
               url='http://webservices.nextbus.com/service/publicXMLFeed?command=routeList&a=umd'
               handle-as="xml"
               on-response="_on_routes_response"></iron-ajax>
    <!-- used for directions and stops -->
    <iron-ajax auto
               url='http://webservices.nextbus.com/service/publicXMLFeed?command=routeConfig&a=umd&r={{routeId}}'
               handle-as="xml"
               on-response="_on_route_response"></iron-ajax>
    <!--<iron-ajax auto
               url='http://webservices.nextbus.com/service/publicXMLFeed?command=predictions&a=umd&stopId={{stopId}}'
               handle-as="xml"
               on-response="_on_stop_response"></iron-ajax> -->
    <iron-ajax auto id="arrival"
               url='http://webservices.nextbus.com/service/publicXMLFeed?command=predictions&a=umd&stopId={{stopId}}&routeTag={{routeId}}'
               handle-as="xml"
               on-response="_on_arrival_response"></iron-ajax>
    <paper-material style="background-color: honeydew;">
      <paper-dropdown-menu label="Select Route">
        <paper-listbox id="lb" on-iron-select="routeSelect" class="dropdown-content" selected="{{selected}}">
          <template is="dom-repeat" items="{{routes}}">
            <paper-item>[[item.title]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <template id="tr" is="dom-repeat" items="{{dirs}}" as="direction">
        <paper-material  elevation="0" style="background-color: tomato" on-tap="directionSelect">
          <span>Direction: [[direction.title]]</span>
          <br>
          <p></p>
          <template id="trr" is="dom-repeat" items="{{direction.stops}}" as="stop">
            <paper-material elevation="0" style="background-color: deepskyblue" on-tap="stopSelect">
              <span>Stop: [[stop.title]]</span>
            </paper-material>
          </template>
        </paper-material>
      </template>
    </paper-material>
    <paper-dialog id="dialog">
      <paper-material>[[stopTitle]]</paper-material>
      <template id="trrr" is="dom-repeat" items="{{predictions}}" as="p">
        <paper-material style="background-color: lightgoldenrodyellow" on-tap="stopSelect">
          <span>Prediction: [[p.minutes]] minutes</span>
        </paper-material>
      </template>
      <div class="buttons">
        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    (function() {
      'use strict';
      //{{computeArray(route.directions,route.stops)}}
      Polymer({
        is: 'bus-data-xml',
        properties: {
          url: {type: String, value: 'hi'},
          routeId: String,
          routeTitle: String,
          directionId: {
            type: String,
            value: '',
          },
          directionTitle: String,
          stopId: String,
          stopTitle: String,
          routes: {},
          directions: {},
          dirs: {},
          selected: {},
          predictions: {}

        },
        // reset variables needed

        routeSelect: function(e) {
          e = null;
          console.log(this.selected + 'hi');
          var route = this.routes[this.selected];
          //console.log(e.model.__data__.item.title);
          //console.log(e.model.__data__.item.title);

          this.routeId = route.tag;
          //this.routeId = e.model.__data__.item.tag;
          this.routeTitle = route.title;
          //this.routeTitle = e.model.__data__.item.title;
          //console.log(this.routeId);
          //this.$.stops.render();
          //console.log(this.$.r.routes);
        },
        directionSelect: function(e) {
          console.log(e.model);
          this.directionId = e.model.__data__.direction.tag;
          this.directionTitle = e.model.__data__.direction.title;

          console.log(this.$.d);

        },
        stopSelect: function(e) {
          this.stopId = e.model.__data__.stop.stopId;
          this.stopTitle = e.model.__data__.stop.title;
          //this.stopTitle = e.model.__data__.stop.title;
          console.log('arrival url');
          console.log(this.$.arrival.url);
          this.$.dialog.open();
        },
        _on_routes_response: function(r) {
          var response = r.detail.response;
          var list = response.querySelectorAll('route');
          this.routes = this._help_parse(r, list);
        },
        _on_arrival_response: function(r) {
          var response = r.detail.response;
          var list = response.querySelectorAll('prediction');
          this.predictions = this._help_parse(r, list);
          console.log(this.predictions);
        },
        _on_route_response: function(r) {
          var response = r.detail.response;
          var directions = response.querySelectorAll('direction');
          this.directions = this._help_parse(r, directions);

          // begin create hashtable
          var s = response.querySelectorAll('stop');
          s = this._help_parse_create_hashtable(r, s);
          console.log(s);
          // end create hashtable

          var stops = [];
          for (var i = 0; i < directions.length; i++) {
            var direction = directions[i];
            //console.log(direction);
            var children = direction.children;
            var dir = {
              tag: direction.getAttribute('tag'),
              title: direction.getAttribute('title'),
              stops: []
            };
            stops.push(dir);
            for (var j = 0; j < children.length; j++) {
              var child = children[j];
              //console.log(child);
              var tag = child.getAttribute('tag');
              stops[i].stops.push(s[tag]);
            }
          }
          console.log(stops);
          //console.log(stops);
          this.dirs = stops;
        },
        /*_compute_stops: function(e) {
          console.log(e);
        },*/
        _help_parse: function(r, list) {

          var tempRoutes = [];
          for (var j = 0; j < list.length; j++) {
            var elem = list[j];
            var tempObj = {};
            for (var i = 0; i < elem.attributes.length; i++) {
              var attrib = elem.attributes[i];
              //console.log(attrib.name + ' = ' + attrib.value);
              tempObj[attrib.name] = attrib.value;
            }
            tempRoutes.push(tempObj);
          }
          return tempRoutes;
        },
        _help_parse_create_hashtable: function(r, list) {

          var tempRoutes = {};
          for (var j = 0; j < list.length; j++) {
            var elem = list[j];
            var tempObj = {};
            for (var i = 0; i < elem.attributes.length; i++) {
              var attrib = elem.attributes[i];
              //console.log(attrib.name + ' = ' + attrib.value);
              tempObj[attrib.name] = attrib.value;
            }
            if (elem.getAttribute('stopId')) {
              tempRoutes[elem.getAttribute('tag')] = tempObj;
            }
          }
          //console.log('create_hashtable');
          //console.log(tempRoutes);
          return tempRoutes;
        },

      });
    })();
  </script>
</dom-module>
